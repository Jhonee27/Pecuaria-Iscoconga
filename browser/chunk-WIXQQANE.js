import{a as u}from"./chunk-RTPLDOJU.js";import{$b as h,A as s,K as p,P as o,S as g,W as d,bc as m,l as c,p as a}from"./chunk-W5R6ALBK.js";var f=class i{constructor(e){this.http=e;this.loadUserFromStorage()}apiUrl=`${u.apiUrl}/auth`;currentUserSubject=new c(null);currentUser$=this.currentUserSubject.asObservable();TOKEN_EXPIRY_BUFFER=300;login(e){return this.http.post(`${this.apiUrl}/login`,e).pipe(o(t=>{this.setAuthData(t)}),s(this.handleError("login")))}logout(){this.http.post(`${this.apiUrl}/logout`,{},{headers:this.getAuthHeaders()}).pipe(s(e=>(console.warn("Error en logout del backend:",e),a(()=>e)))).subscribe(),this.clearAuthData()}changePassword(e){let t=[`${this.apiUrl}/change-password`,`${this.apiUrl}/update-password`,`${this.apiUrl}/password`,`${u.apiUrl}/users/change-password`],r=n=>(console.log(`\u{1F50D} Probando endpoint: ${n}`),this.http.post(n,e,{headers:this.getAuthHeaders()}).pipe(p(1),s(l=>(console.log(`\u274C Endpoint fall\xF3: ${n}`,l.status),a(()=>l)))));return r(t[0]).pipe(s(()=>r(t[1])),s(()=>r(t[2])),s(()=>r(t[3])),s(this.handleError("changePassword")),o(n=>{n.user&&this.updateCurrentUser(n.user)}))}isTokenExpiringSoon(){let e=this.getToken();if(!e)return!0;try{let r=JSON.parse(atob(e.split(".")[1])).exp*1e3,n=Date.now();return r-n<this.TOKEN_EXPIRY_BUFFER*1e3}catch{return!0}}refreshToken(){return this.http.post(`${this.apiUrl}/refresh`,{},{headers:this.getAuthHeaders()}).pipe(o(e=>{this.setAuthData(e)}),s(e=>(this.clearAuthData(),a(()=>e))))}getCurrentUser(){return this.currentUserSubject.value}isAuthenticated(){return this.getToken()?this.isTokenExpiringSoon()?(console.warn("Token pr\xF3ximo a expirar"),!1):!!this.getCurrentUser():!1}hasRole(e){let t=this.getCurrentUser();return t?t.role===e:!1}getToken(){return localStorage.getItem("token")}getTokenInfo(){let e=this.getToken();if(!e)return null;try{let t=JSON.parse(atob(e.split(".")[1]));return{email:t.email,role:t.role,exp:new Date(t.exp*1e3),iat:new Date(t.iat*1e3)}}catch{return null}}setAuthData(e){if(localStorage.setItem("token",e.token),localStorage.setItem("user",JSON.stringify(e.user)),e.expiresIn){let t=Date.now()+e.expiresIn*1e3;localStorage.setItem("token_expiry",t.toString())}this.currentUserSubject.next(e.user)}clearAuthData(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("token_expiry"),this.currentUserSubject.next(null)}updateCurrentUser(e){localStorage.setItem("user",JSON.stringify(e)),this.currentUserSubject.next(e)}loadUserFromStorage(){let e=localStorage.getItem("token"),t=localStorage.getItem("user");if(e&&t){let r=JSON.parse(t);this.currentUserSubject.next(r)}}getAuthHeaders(){let e=this.getToken(),t={"Content-Type":"application/json"};return e&&(t.Authorization=`Bearer ${e}`),new h(t)}handleError(e){return t=>{console.error(`\u274C Error en ${e}:`,t);let r={message:this.getErrorMessage(t),status:t.status,timestamp:new Date().toISOString(),details:t.error};return(t.status===401||t.status===403)&&(console.warn("Error de autenticaci\xF3n, limpiando datos..."),this.clearAuthData()),a(()=>r)}}getErrorMessage(e){if(e.error instanceof ErrorEvent)return`Error del cliente: ${e.error.message}`;switch(e.status){case 0:return"No se puede conectar al servidor. Verifica tu conexi\xF3n a internet.";case 400:return e.error?.message||"Solicitud inv\xE1lida.";case 401:return"No autorizado. Tu sesi\xF3n ha expirado.";case 403:return"Acceso denegado. No tienes permisos para esta acci\xF3n.";case 404:return"El recurso solicitado no existe.";case 409:return"Conflicto: El recurso ya existe.";case 422:return"Datos de entrada inv\xE1lidos.";case 429:return"Demasiadas solicitudes. Intenta m\xE1s tarde.";case 500:return"Error interno del servidor. Contacta al administrador.";case 503:return"Servicio no disponible. Intenta m\xE1s tarde.";default:return e.error?.message||`Error inesperado: ${e.status}`}}static \u0275fac=function(t){return new(t||i)(d(m))};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a};
